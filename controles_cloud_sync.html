<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Prépa Contrôles – Multi-projets avec sync</title>
<style>
  :root{--bg:#0f1220;--card:#171a2b;--muted:#9aa0b4;--text:#f3f5ff;--accent:#6ea8fe;--accent-strong:#2f7dff;--good:#4ade80;--warn:#f59e0b;--bad:#ef4444;--radius:14px}
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;font:16px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Helvetica Neue,Arial;background:radial-gradient(1200px 800px at 20% -10%,#1b2140 0%,#0f1220 45%,#0b0e1a 100%);color:var(--text)}
  .container{max-width:1100px;margin:0 auto;padding:24px}
  h1{margin:0 0 8px;font-size:26px}.muted{color:var(--muted)}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;align-items:start}
  @media (max-width:900px){.grid{grid-template-columns:1fr}}
  .card{background:linear-gradient(180deg,#1b1f33 0%,#15192a 100%);border:1px solid #22263d;border-radius:var(--radius);padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  label{display:block;margin:8px 0 6px}
  input,select{width:100%;padding:11px 12px;border-radius:12px;border:1px solid #2a2f4a;background:#0f1330;color:var(--text);outline:none}
  input::placeholder{color:#7680a5} input:focus{border-color:#3e64ff}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .btn{appearance:none;border:1px solid #2a2f4a;background:#0f1330;color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer;transition:transform .06s,background .15s,border .15s}
  .btn:hover{border-color:#3e64ff} .btn:active{transform:translateY(1px)}
  .btn.primary{background:linear-gradient(180deg,#2f7dff,#2063ff);border-color:#2b63f5}
  .btn.good{background:linear-gradient(180deg,#2a8a5a,#1d7047);border-color:#1f8a56}
  .btn.warn{background:linear-gradient(180deg,#a86c13,#8b5408);border-color:#b67a1f}
  .btn.small{padding:7px 10px;font-size:14px}
  .sync-status{display:flex;align-items:center;gap:8px;font-size:12px;color:var(--muted)}
  .sync-dot{width:8px;height:8px;border-radius:50%;background:var(--muted)}
  .sync-dot.online{background:var(--good);animation:pulse 2s infinite}
  .sync-dot.syncing{background:var(--warn);animation:spin 1s linear infinite}
  .sync-dot.error{background:var(--bad)}
  @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
  @keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
  .stats{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin:14px 0}
  .stat{padding:12px;border:1px solid #2a2f4a;background:#0f1330;border-radius:12px;text-align:center}
  .stat .v{font-size:20px;font-variant-numeric:tabular-nums}.stat .l{font-size:12px;color:var(--muted)}
  .list{display:grid;gap:14px}
  .proj{padding:14px;border:1px solid #2a2f4a;background:#0f1330;border-radius:14px}
  .proj-head{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-bottom:8px;flex-wrap:wrap}
  .title{font-weight:600}.tags{display:flex;gap:8px;flex-wrap:wrap}
  .tag{padding:4px 8px;border-radius:999px;border:1px solid #2a2f4a;background:#0f1330;color:#e6eaff;font-size:12px}
  .progress{background:#0b0f26;border:1px solid #2a2f4a;border-radius:14px;height:18px;position:relative;overflow:hidden}
  .bar{position:absolute;inset:0 auto 0 0;width:0%;background:linear-gradient(90deg,#2f7dff,#6ea8fe);box-shadow:0 0 20px rgba(110,168,254,.35) inset;transition:width .35s ease}
  .meta{display:flex;justify-content:space-between;font-variant-numeric:tabular-nums;margin-top:6px}
  .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .chip{padding:7px 10px;border-radius:999px;border:1px solid #2a2f4a;background:#0f1330;cursor:pointer}
  .chip:hover{border-color:#3e64ff}
  .est{font-weight:600}.est.good{color:var(--good)}.est.mid{color:var(--warn)}.est.bad{color:var(--bad)}
  .daily-req{font-weight:600}.daily-req.good{color:var(--good)}.daily-req.mid{color:var(--warn)}.daily-req.bad{color:var(--bad)}
  .user-setup{background:linear-gradient(180deg,#2a1f33 0%,#1f192a 100%);border:1px solid #3d2263;margin-bottom:16px}
</style>
</head>
<body>
  <div class="container">
    <h1>Prépa Contrôles <span class="sync-status"><span class="sync-dot" id="sync-dot"></span><span id="sync-text">Hors ligne</span></span></h1>
    <p class="muted">Ajoute tes heures, vois l'estimation, synchronise entre tes appareils.</p>

    <!-- Configuration utilisateur -->
    <div class="card user-setup">
      <h3>Configuration de la synchronisation</h3>
      <label for="user-id">Identifiant unique (partage entre tes appareils)</label>
      <div class="row">
        <input id="user-id" placeholder="ex: mon-nom-2024" style="flex:1">
        <button class="btn primary" id="connect-btn">Se connecter</button>
        <button class="btn small" id="generate-id">Générer ID</button>
      </div>
      <p class="muted" style="font-size:12px;margin-top:8px">⚠️ Note cet identifiant pour le réutiliser sur d'autres appareils</p>
    </div>

    <!-- Stats globales -->
    <div class="stats">
      <div class="stat"><div class="v" id="stat-total">0 h</div><div class="l">Total d'heures travaillées</div></div>
      <div class="stat"><div class="v" id="stat-sessions">0</div><div class="l">Sessions enregistrées</div></div>
      <div class="stat"><div class="v" id="stat-projets">0</div><div class="l">Contrôles (en cours / terminés)</div></div>
    </div>

    <div class="grid">
      <section class="card">
        <h2>Nouveau contrôle</h2>
        <label for="t">Titre</label>
        <input id="t" placeholder="Ex: DS de maths – suites & récurrence">
        <div class="row" style="gap:10px;margin-top:6px">
          <div style="flex:1">
            <label for="g">Objectif (heures)</label>
            <input id="g" type="number" step="0.25" min="0.25" placeholder="ex: 12">
          </div>
          <div style="flex:1">
            <label for="d">Échéance (facultatif)</label>
            <input id="d" type="date">
          </div>
        </div>
        <div class="row" style="gap:10px;margin-top:10px">
          <button class="btn primary" id="addProject">➕ Ajouter le contrôle</button>
          <button class="btn small" id="exportBtn">⬇️ Export CSV</button>
          <button class="btn small warn" id="wipeAll">Remise à zéro</button>
        </div>
      </section>

      <section class="card">
        <h2>Conseil</h2>
        <p class="muted">L'estimation (sur 20) est bornée et lissée selon ton avancement, ton rythme (h/j), l'échéance et la régularité. Les données se synchronisent automatiquement entre tes appareils.</p>
      </section>
    </div>

    <h2 style="margin:18px 0 8px">Mes contrôles</h2>
    <div id="list" class="list"></div>

    <h2 style="margin:18px 0 8px">Contrôles terminés</h2>
    <div id="finished" class="list"></div>
  </div>

<script>
(function(){
  const $ = s => document.querySelector(s);
  const elList = $('#list'), elFinished = $('#finished');
  const LOCAL_STORAGE = 'prep-multi-v4';
  const isoNow = () => new Date().toISOString();
  const fmtDateTime = iso => new Intl.DateTimeFormat('fr-FR',{dateStyle:'medium',timeStyle:'short'}).format(new Date(iso));
  const state = { projects: [], userId: '', lastSync: null };
  
  // Cloud storage simulation (remplace par un vrai service)
  const CloudStorage = {
    baseUrl: 'https://api.jsonbin.io/v3/b', // Service gratuit pour demo
    
    async save(userId, data) {
      try {
        const response = await fetch(`${this.baseUrl}/${userId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'X-Master-Key': '$2a$10$XYZ123' // Remplace par ta clé API
          },
          body: JSON.stringify({data, lastModified: Date.now()})
        });
        return response.ok;
      } catch (e) {
        console.error('Cloud save error:', e);
        return false;
      }
    },
    
    async load(userId) {
      try {
        const response = await fetch(`${this.baseUrl}/${userId}`, {
          headers: {
            'X-Master-Key': '$2a$10$XYZ123' // Remplace par ta clé API
          }
        });
        if (response.ok) {
          const result = await response.json();
          return result.record;
        }
        return null;
      } catch (e) {
        console.error('Cloud load error:', e);
        return null;
      }
    }
  };

  function updateSyncStatus(status, text) {
    const dot = $('#sync-dot');
    const textEl = $('#sync-text');
    dot.className = `sync-dot ${status}`;
    textEl.textContent = text;
  }

  function loadLocal() { 
    try{ 
      if(typeof Storage === "undefined") return;
      const raw = localStorage.getItem(LOCAL_STORAGE); 
      if(raw) Object.assign(state, JSON.parse(raw)); 
    }catch(e){ 
      console.error('Error loading local data:', e);
    } 
  }
  
  function saveLocal() { 
    try{
      if(typeof Storage === "undefined") return;
      localStorage.setItem(LOCAL_STORAGE, JSON.stringify(state)); 
    }catch(e){
      console.error('Error saving local data:', e);
    }
  }

  async function syncToCloud() {
    if (!state.userId) return;
    
    updateSyncStatus('syncing', 'Synchronisation...');
    const success = await CloudStorage.save(state.userId, {
      projects: state.projects,
      lastSync: Date.now()
    });
    
    if (success) {
      state.lastSync = Date.now();
      saveLocal();
      updateSyncStatus('online', 'Synchronisé');
    } else {
      updateSyncStatus('error', 'Erreur sync');
    }
  }

  async function syncFromCloud() {
    if (!state.userId) return;
    
    updateSyncStatus('syncing', 'Chargement...');
    const cloudData = await CloudStorage.load(state.userId);
    
    if (cloudData && cloudData.data) {
      const shouldUpdate = !state.lastSync || cloudData.lastModified > state.lastSync;
      if (shouldUpdate) {
        state.projects = cloudData.data.projects || [];
        state.lastSync = cloudData.lastModified;
        saveLocal();
        render();
      }
      updateSyncStatus('online', 'Synchronisé');
    } else {
      updateSyncStatus('online', 'Première connexion');
    }
  }

  // Fonctions existantes (identiques à avant)
  function sumHours(p){ return p.entries?.reduce((a,e)=> a + Number(e.hours||0), 0) || 0; }
  function totalHoursAll(){ return state.projects.reduce((acc,p)=> acc + sumHours(p), 0); }
  function totalSessionsAll(){ return state.projects.reduce((acc,p)=> acc + (p.entries?.length || 0), 0); }
  function fmtHM(hours){ const m = Math.round(Number(hours||0)*60); const h = Math.floor(m/60), r = m%60; return `${h}\u00A0h${r?` ${r}\u00A0min`:''}`; }

  function earliestISO(p){ if(!p.entries?.length) return null; return [...p.entries].sort((a,b)=> new Date(a.atISO)-new Date(b.atISO))[0].atISO; }
  function paceHPD(p){ const total=sumHours(p); const start=earliestISO(p); if(!start||total<=0) return 0; const days=(Date.now()-new Date(start).getTime())/86400000; return Math.min(total/Math.max(days,0.0001),16); }
  function etaStr(p){ const g=+p.goal||0, done=sumHours(p), left=Math.max(g-done,0), pace=paceHPD(p); if(left===0) return 'Terminé 🎉'; if(pace<=0) return '—'; const dt=new Date(Date.now()+left/pace*86400000); const z=n=>String(n).padStart(2,'0'); return `${dt.getFullYear()}-${z(dt.getMonth()+1)}-${z(dt.getDate())}`; }

  function dailyRequired(p){
    const goal = +p.goal||0, done = sumHours(p), left = Math.max(goal-done,0);
    if(left === 0) return {hours: 0, text: 'Terminé ✅', class: 'good'};
    if(!p.deadline) return {hours: 0, text: 'Pas d\'échéance', class: 'good'};
    
    const end = new Date(p.deadline+'T23:59:59');
    const daysLeft = Math.max((end - Date.now())/86400000, 0);
    
    if(daysLeft <= 0) return {hours: 0, text: 'Échéance passée ⚠️', class: 'bad'};
    if(daysLeft < 1) return {hours: left, text: `${fmtHM(left)}/j (urgent!)`, class: 'bad'};
    
    const hoursPerDay = left / Math.max(daysLeft, 0.01);
    let className = 'good';
    let text = `${fmtHM(hoursPerDay)}/j`;
    
    if(hoursPerDay > 4) className = 'bad';
    else if(hoursPerDay > 2) className = 'mid';
    
    return {hours: hoursPerDay, text, class: className};
  }

  function clamp(a,x,b){ return Math.max(a, Math.min(b,x)); }
  function clamp01(x){ return clamp(0,x,1); }
  function gradeInterval(p){
    const goal = +p.goal||0, done = sumHours(p), left = Math.max(goal-done,0);
    if(goal<=0) return {lo:6,hi:12,why:'objectif non défini'};
    if(left===0) return {lo:18,hi:20,why:'objectif atteint'};

    const progress = clamp01(done/goal);
    const pace = paceHPD(p);

    let readiness;
    if(p.deadline){
      const end = new Date(p.deadline+'T23:59:59');
      const daysLeft = Math.max((end - Date.now())/86400000, 0);
      if(daysLeft===0) return {lo:4,hi:9,why:'échéance dépassée'};
      const req = left / Math.max(daysLeft, 0.01);
      const ratio = pace / Math.max(req, 0.01);
      const paceScore = 0.5 + 0.5*Math.tanh((ratio-1)*1.2);
      readiness = clamp01(0.6*progress + 0.4*paceScore);
    }else{
      const rel = clamp01((pace*14)/Math.max(left,0.01));
      readiness = clamp01(0.7*progress + 0.3*rel);
    }

    const sessions = p.entries?.length || 0;
    const confidence = clamp01(sessions/6);

    let center = 20*(0.4 + 0.6*readiness);
    center = clamp(5, center, 19);
    const base = 6;
    const width = Math.max(1.5, base * (1-0.5*confidence) * (1-0.2*readiness));

    let lo = clamp(0, center - width, 20);
    let hi = clamp(0, center + width, 20);
    if(hi < lo){ const m=(hi+lo)/2; lo=m-1; hi=m+1; }
    return {lo,hi,why: (p.deadline? 'avec échéance' : 'sans échéance')};
  }
  const fmtGrade = x => (Math.round(x*10)/10).toFixed(1).replace(/\.0$/,'');

  // CRUD avec sync
  async function addProject(title,goal,deadline){ 
    state.projects.push({
      id:Date.now()+Math.random().toString(16).slice(2), 
      title:title.trim(), 
      goal:+goal, 
      deadline:deadline||'', 
      entries:[], 
      completed:false
    }); 
    saveLocal(); 
    render(); 
    await syncToCloud();
  }
  
  async function addEntry(p,h){ 
    const v=+h; 
    if(!isFinite(v)||v<=0){
      alert('Durée invalide.'); 
      return;
    } 
    if(!p.entries) p.entries = [];
    p.entries.push({
      id: Date.now() + Math.random().toString(16).slice(2), 
      hours: v, 
      atISO: isoNow()
    }); 
    saveLocal(); 
    render(); 
    await syncToCloud();
  }
  
  async function completeProject(p){ 
    const s=prompt('Note obtenue (sur 20) :', p.grade!=null?String(p.grade):''); 
    if(s===null) return; 
    const n=+s; 
    if(!isFinite(n)||n<0||n>20) return alert('Entre une note entre 0 et 20.'); 
    p.grade = Math.round(n*10)/10; 
    p.completed = true; 
    p.completedAt = isoNow(); 
    saveLocal(); 
    render(); 
    await syncToCloud();
  }
  
  async function reopenProject(p){ 
    p.completed=false; 
    saveLocal(); 
    render(); 
    await syncToCloud();
  }
  
  async function deleteProject(p){ 
    if(confirm("Supprimer ce contrôle ?\n(Attention : supprime aussi l'historique)")){ 
      state.projects = state.projects.filter(x => x.id !== p.id);
      saveLocal(); 
      render(); 
      await syncToCloud();
    } 
  }
  
  async function editProject(p){
    const nt=prompt('Nouveau titre :', p.title); if(nt===null) return;
    const ng=prompt('Nouvel objectif (heures) :', String(p.goal)); if(ng===null) return;
    const nd=prompt('Nouvelle échéance (YYYY-MM-DD, vide si aucune) :', p.deadline||''); if(nd===null) return;
    if(!nt.trim()) return alert('Titre requis');
    const g=+ng; if(!isFinite(g)||g<=0) return alert('Objectif invalide');
    if(nd && !/^\d{4}-\d{2}-\d{2}$/.test(nd)) return alert('Date invalide');
    p.title=nt.trim(); p.goal=g; p.deadline=nd.trim(); 
    saveLocal(); 
    render(); 
    await syncToCloud();
  }

  // Render functions (identiques à avant mais avec les nouvelles fonctions async)
  function render(){
    elList.innerHTML = ''; elFinished.innerHTML='';
    $('#stat-total').textContent = fmtHM(totalHoursAll());
    $('#stat-sessions').textContent = totalSessionsAll();
    $('#stat-projets').textContent = `${state.projects.filter(p=>!p.completed).length} / ${state.projects.filter(p=>p.completed).length}`;

    const ongoing = state.projects.filter(p=>!p.completed).slice().sort((a,b)=>(a.deadline||'9999-12-31').localeCompare(b.deadline||'9999-12-31'));
    const done = state.projects.filter(p=>p.completed).slice().sort((a,b)=> new Date(b.completedAt||0)-new Date(a.completedAt||0));

    if(!ongoing.length){ const e=document.createElement('div'); e.className='muted'; e.textContent='Aucun contrôle en cours.'; elList.appendChild(e); }
    ongoing.forEach(p=> elList.appendChild(renderOngoing(p)));

    if(!done.length){ const e=document.createElement('div'); e.className='muted'; e.textContent='Aucun contrôle terminé.'; elFinished.appendChild(e); }
    done.forEach(p=> elFinished.appendChild(renderFinished(p)));
  }

  function renderOngoing(p){
    const w = document.createElement('div'); w.className='proj';
    const done = sumHours(p), pct = p.goal? Math.min(100, Math.round(done/p.goal*100)) : 0, gi = gradeInterval(p);
    const dailyReq = dailyRequired(p);

    const head = document.createElement('div'); head.className='proj-head';
    const L = document.createElement('div'); L.innerHTML = `<div class="title">${escapeHtml(p.title)}</div>`;
    const R = document.createElement('div'); R.className='row';
    const bEdit = btn('Éditer','small', () => editProject(p));
    const bDel = btn('Supprimer','small warn', () => deleteProject(p));
    R.appendChild(bEdit); R.appendChild(bDel);
    head.appendChild(L); head.appendChild(R);

    const tags = document.createElement('div'); tags.className='tags';
    const estClass = gi.hi>=15? 'good' : gi.hi>=12? 'mid' : 'bad';
    tags.innerHTML = `<span class="tag">Obj: ${fmtHM(p.goal)}</span>`+
                     `<span class="tag">${p.deadline||'Sans échéance'}</span>`+
                     `<span class="tag est"><span class="${estClass}">${fmtGrade(gi.lo)}–${fmtGrade(gi.hi)}/20</span> estimé</span>`+
                     `<span class="tag daily-req"><span class="${dailyReq.class}">${dailyReq.text}</span></span>`+
                     `<span class="tag">ETA ${etaStr(p)}</span>`;

    const prog = document.createElement('div'); prog.className='progress'; prog.innerHTML = `<div class="bar" style="width:${pct}%"></div>`;
    const meta = document.createElement('div'); meta.className='meta'; meta.innerHTML = `<span>${pct}%</span><span>${fmtHM(done)} / ${fmtHM(p.goal)}</span>`;

    const actions = document.createElement('div'); actions.className='actions';
    const inp = document.createElement('input'); inp.type='number'; inp.step='0.25'; inp.min='0.25'; inp.placeholder='Durée (h décimales, ex 1.5 = 1 h 30)'; inp.style.width='240px';
    const bAdd = btn('Ajouter','',() => { addEntry(p, Number(inp.value)); inp.value=''; });
    const chips = [0.25,0.5,1,2].map(q=> chip('+'+q+'h', () => addEntry(p,q)));
    const bDone = btn('✅ Terminer','', () => completeProject(p));
    actions.appendChild(inp); actions.appendChild(bAdd); chips.forEach(c=>actions.appendChild(c)); actions.appendChild(bDone);

    w.appendChild(head); w.appendChild(tags); w.appendChild(prog); w.appendChild(meta); w.appendChild(actions);
    return w;
  }

  function renderFinished(p){
    const w = document.createElement('div'); w.className='proj';
    const head = document.createElement('div'); head.className='proj-head';
    const L = document.createElement('div'); L.innerHTML = `<div class="title">${escapeHtml(p.title)}</div>`;
    const R = document.createElement('div'); R.className='row';
    const bEdit = btn('Modifier note','small', () => completeProject(p));
    const bReop = btn('↩️ Repasser en cours','small', () => reopenProject(p));
    const bDel = btn('Supprimer','small warn', () => deleteProject(p));
    R.appendChild(bEdit); R.appendChild(bReop); R.appendChild(bDel);
    head.appendChild(L); head.appendChild(R);

    const tags = document.createElement('div'); tags.className='tags';
    tags.innerHTML = `<span class="tag">Obj: ${fmtHM(p.goal)}</span>`+
                     (p.deadline? `<span class="tag">Échéance: ${p.deadline}</span>`:'')+
                     `<span class="tag">Terminé le ${fmtDateTime(p.completedAt||isoNow())}</span>`+
                     `<span class="tag"><strong>Note: ${fmtGrade(p.grade??0)}/20</strong></span>`;

    const meta = document.createElement('div'); meta.className='meta';
    meta.innerHTML = `<span>Total fait: ${fmtHM(sumHours(p))}</span><span>Sessions: ${p.entries?.length || 0}</span>`;

    w.appendChild(head); w.appendChild(tags); w.appendChild(meta);
    return w;
  }

  function btn(label, extra, on){ 
    const b = document.createElement('button'); 
    b.className = 'btn' + (extra ? (' ' + extra) : ''); 
    b.textContent = label; 
    if(on && typeof on === 'function') {
      b.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        on();
      }); 
    }
    return b; 
  }
  
  function chip(label, on){ 
    const c = document.createElement('button'); 
    c.className = 'chip'; 
    c.textContent = label; 
    if(on && typeof on === 'function') {
      c.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        on();
      }); 
    }
    return c; 
  }
  
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }

  // Event handlers
  $('#addProject').addEventListener('click', async () => {
    const t=$('#t').value.trim(), g=Number($('#g').value), d=$('#d').value;
    if(!t) return alert('Titre requis');
    if(!isFinite(g)||g<=0) return alert('Objectif invalide');
    if(d && !/^\d{4}-\d{2}-\d{2}$/.test(d)) return alert('Date invalide (format YYYY-MM-DD requis)');
    await addProject(t,g,d); 
    $('#t').value=''; $('#g').value=''; $('#d').value='';
  });

  $('#wipeAll').addEventListener('click', async () => { 
    if(confirm('Tout effacer ? Cette action est irréversible.')){ 
      state.projects=[]; 
      saveLocal(); 
      render(); 
      await syncToCloud();
    } 
  });

  $('#exportBtn').addEventListener('click', () => {
    try {
      const rows=[['Titre','Objectif_h','Deadline','Terminé','Note_20','Date_fin','Entrée_id','Heures','Horodatage_ISO']];
      state.projects.forEach(p=>{
        if(!p.entries || p.entries.length===0){ 
          rows.push([p.title||'',p.goal||0,p.deadline||'',!!p.completed,p.grade??'',p.completedAt||'','',0,'']); 
        } else {
          p.entries.forEach(e=> rows.push([p.title||'',p.goal||0,p.deadline||'',!!p.completed,p.grade??'',p.completedAt||'',e.id||'',e.hours||0,e.atISO||'']));
        }
      });
      const csv = rows.map(r=> r.map(x=>`"${String(x).replaceAll('"','""')}"`).join(',')).join('\n');
      const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
      const a=document.createElement('a'); 
      a.href=URL.createObjectURL(blob); 
      a.download='controles.csv'; 
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(a.href);
    } catch(e) {
      console.error('Erreur export CSV:', e);
      alert('Erreur lors de l\'export CSV');
    }
  });

  // Sync handlers
  $('#connect-btn').addEventListener('click', async () => {
    const userId = $('#user-id').value.trim();
    if (!userId) return alert('Identifiant requis');
    if (!/^[a-zA-Z0-9-_]+$/.test(userId)) return alert('Identifiant invalide (lettres, chiffres, - et _ seulement)');
    
    state.userId = userId;
    saveLocal();
    await syncFromCloud();
  });

  $('#generate-id').addEventListener('click', () => {
    const id = 'user-' + Date.now().toString(36) + Math.random().toString(36).slice(2);
    $('#user-id').value = id;
  });

  // Auto-sync every 30 seconds
  setInterval(async () => {
    if (state.userId) {
      await syncFromCloud();
    }
  }, 30000);

  // Sync on page focus (when switching between tabs/apps)
  document.addEventListener('visibilitychange', async () => {
    if (!document.hidden && state.userId) {
      await syncFromCloud();
    }
  });

  // Initialize
  loadLocal();
  if (state.userId) {
    $('#user-id').value = state.userId;
    syncFromCloud();
  }
  render();
})();
</script>
</body>
</html>